<div class="order-detail-container">
  <!-- Loading -->
  <div *ngIf="isLoading" class="loading">
    <p>ƒêang t·∫£i chi ti·∫øt ƒë∆°n h√†ng...</p>
  </div>

  <!-- Order Detail -->
  <div *ngIf="!isLoading && order" class="order-detail">
    <!-- Header -->
    <div class="detail-header">
      <button (click)="onGoBack()" class="btn btn-back">
        ‚Üê Quay l·∫°i
      </button>
      <h2>Chi ti·∫øt ƒë∆°n h√†ng #{{order.id}}</h2>
      <div class="header-actions">
        <button (click)="onPrintOrder()" class="btn btn-print">
          üñ®Ô∏è In ƒë∆°n h√†ng
        </button>
        
        <!-- Admin Actions -->
        <div *ngIf="isAdmin" class="admin-actions">
          <!-- N√∫t x√°c nh·∫≠n - ch·ªâ hi·ªÉn th·ªã khi orderStatus l√† CONFIRMED -->
          <button *ngIf="order.orderStatus === 'CONFIRMED'" 
                  (click)="onStatusButtonClick('confirm')"
                  [disabled]="isButtonDisabled(order.orderStatus)"
                  class="btn btn-confirm">
            X√°c nh·∫≠n ƒë∆°n h√†ng
          </button>

          <!-- N√∫t b·∫Øt ƒë·∫ßu giao - ch·ªâ hi·ªÉn th·ªã khi orderStatus l√† PAID -->
          <button *ngIf="order.orderStatus === 'PAID'" 
                  (click)="onStatusButtonClick('ship')"
                  [disabled]="isButtonDisabled(order.orderStatus)"
                  class="btn btn-ship">
            B·∫Øt ƒë·∫ßu giao h√†ng
          </button>

          <!-- N√∫t ho√†n th√†nh - ch·ªâ hi·ªÉn th·ªã khi orderStatus l√† SHIPPING -->
          <button *ngIf="order.orderStatus === 'SHIPPING'" 
                  (click)="onStatusButtonClick('complete')"
                  [disabled]="isButtonDisabled(order.orderStatus)"
                  class="btn btn-complete">
            Ho√†n th√†nh ƒë∆°n h√†ng
          </button>

          <!-- Hi·ªÉn th·ªã th√¥ng b√°o cho c√°c tr·∫°ng th√°i kh√¥ng th·ªÉ thao t√°c -->
          <span *ngIf="isButtonDisabled(order.orderStatus) && order.orderStatus" class="no-action-text">
            Kh√¥ng th·ªÉ thao t√°c
          </span>
        </div>
      </div>
    </div>

    <!-- Order Status -->
    <div class="status-section">
      <div class="status-info">
        <strong>Tr·∫°ng th√°i:</strong>
        <span class="status-badge" [class]="getStatusClass(order.orderStatus)">
          {{getStatusText(order.orderStatus)}}
        </span>
      </div>
    </div>

    <!-- Two Columns Layout -->
    <div class="detail-content">
      <!-- Left Column - Customer & Order Info -->
      <div class="left-column">
        <!-- Customer Information -->
        <div class="info-card">
          <h3>Th√¥ng tin {{isAdmin ? 'kh√°ch h√†ng' : 'c·ªßa t√¥i'}}</h3>
          <div class="info-grid">
            <div class="info-item">
              <strong>H·ªç t√™n:</strong>
              <span>{{getCustomerFullName()}}</span>
            </div>
            <div class="info-item">
              <strong>Email:</strong>
              <span>{{order.email || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <strong>S·ªë ƒëi·ªán tho·∫°i:</strong>
              <span>{{order.phone || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <strong>ƒê·ªãa ch·ªâ:</strong>
              <span>{{order.address || 'N/A'}}</span>
            </div>
            <div class="info-item" *ngIf="order.town">
              <strong>Th·ªã tr·∫•n/Th√†nh ph·ªë:</strong>
              <span>{{order.town}}</span>
            </div>
            <div class="info-item" *ngIf="order.country">
              <strong>Qu·ªëc gia:</strong>
              <span>{{order.country}}</span>
            </div>
          </div>
        </div>

        <!-- Order Information -->
        <div class="info-card">
          <h3>Th√¥ng tin ƒë∆°n h√†ng</h3>
          <div class="info-grid">
            <div class="info-item">
              <strong>M√£ ƒë∆°n h√†ng:</strong>
              <span>#{{order.id}}</span>
            </div>
            <div class="info-item">
              <strong>T·ªïng s·∫£n ph·∫©m:</strong>
              <span>{{calculateTotalQuantity()}} s·∫£n ph·∫©m</span>
            </div>
            <div class="info-item">
              <strong>Ng√†y ƒë·∫∑t h√†ng:</strong>
              <span>{{formatDate(order.dateOrder) || 'N/A'}}</span>
            </div>
            <div class="info-item">
              <strong>Ng√†y thanh to√°n:</strong>
              <span [class]="order.orderStatus === 'PAID' ? 'payment-date paid' : 'payment-date not-paid'">
                {{formatDate(getPaymentDate())}}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Order Items & Notes -->
      <div class="right-column">
        <!-- Order Items -->
        <div class="info-card">
          <h3>Chi ti·∫øt s·∫£n ph·∫©m ({{orderItems.length}} s·∫£n ph·∫©m)</h3>
          <!-- Ph·∫ßn hi·ªÉn th·ªã s·∫£n ph·∫©m trong order-items -->
        <!-- Trong ph·∫ßn order items -->
        <div *ngIf="orderItems.length > 0" class="order-items">
          <div *ngFor="let item of orderItems" class="order-item">
            <div class="item-info">
              <div class="item-main">
                <h4>{{item.name || 'S·∫£n ph·∫©m #' + item.productId}}</h4>
                <div class="item-details">
                  <p class="item-price">Gi√°: {{item.price | currency:'VND':'symbol':'1.0-0'}}</p>
                  <p class="item-quantity">S·ªë l∆∞·ª£ng: {{item.quantity}}</p>
                  <p class="item-id">M√£ SP: {{item.productId}}</p>
                </div>
                
                <!-- Hi·ªÉn th·ªã tr·∫°ng th√°i ƒë√°nh gi√° - CH·ªà khi order ƒë√£ COMPLETED -->
                <div class="rating-status" *ngIf="order?.orderStatus === 'COMPLETED'">
                  <div class="review-status-info">
                    <small class="review-status-text">{{getReviewStatusText(item)}}</small>
                  </div>
                  
                  <!-- ƒê√É ƒê√ÅNH GI√Å - Hi·ªÉn th·ªã n√∫t "Xem ƒë√°nh gi√°" -->
                  <div *ngIf="canViewReview(item)" class="reviewed">
                    <span class="review-badge">‚úÖ ƒê√£ ƒë√°nh gi√°</span>
                    <span class="review-rating">
                      <span class="stars">
                        <span *ngFor="let star of [1,2,3,4,5]" 
                              [class.filled]="star <= getProductRating(item)"
                              class="star">
                          ‚òÖ
                        </span>
                      </span>
                      ({{getProductRating(item)}}/5)
                    </span>
                    <button (click)="viewReview(item)" class="btn btn-view-review">
                      üëÅÔ∏è Xem ƒë√°nh gi√°
                    </button>
                  </div>
                  
                  <!-- CH∆ØA ƒê√ÅNH GI√Å - Hi·ªÉn th·ªã n√∫t "ƒê√°nh gi√° s·∫£n ph·∫©m" -->
                  <div *ngIf="canReviewProduct(item)" class="not-reviewed">
                    <button (click)="openReviewModal(item)" class="btn btn-review">
                      ‚≠ê ƒê√°nh gi√° s·∫£n ph·∫©m
                    </button>
                  </div>

                  <!-- KH√îNG TH·ªÇ ƒê√ÅNH GI√Å - Cho admin ho·∫∑c c√°c tr∆∞·ªùng h·ª£p kh√°c -->
                  <div *ngIf="!canReviewProduct(item) && !canViewReview(item)" 
                      class="cannot-review">
                    <span class="cannot-review-text">Kh√¥ng th·ªÉ ƒë√°nh gi√°</span>
                  </div>
                </div>
              </div>
              <div class="item-total">
                {{item.subTotal | currency:'VND':'symbol':'1.0-0'}}
              </div>
            </div>
          </div>
        </div>
          <div *ngIf="orderItems.length === 0" class="no-items">
            <p>Kh√¥ng c√≥ s·∫£n ph·∫©m trong ƒë∆°n h√†ng</p>
          </div>
        </div>

        <!-- Notes -->
        <div class="info-card">
          <h3>Ghi ch√∫ ƒë∆°n h√†ng</h3>
          <div class="notes-content">
            <p>{{order.note || 'Kh√¥ng c√≥ ghi ch√∫'}}</p>
          </div>
        </div>

        <!-- User Information (Ch·ªâ hi·ªÉn th·ªã cho admin) -->
        <div class="info-card" *ngIf="isAdmin && order.user">
          <h3>Th√¥ng tin t√†i kho·∫£n</h3>
          <div class="info-grid">
            <div class="info-item">
              <strong>Username:</strong>
              <span>{{order.user.username}}</span>
            </div>
            <div class="info-item">
              <strong>Email:</strong>
              <span>{{order.user.email}}</span>
            </div>
            <div class="info-item">
              <strong>Vai tr√≤:</strong>
              <span>{{order.user.role === 'ROLE_ADMIN' ? 'Qu·∫£n tr·ªã vi√™n' : 'Ng∆∞·ªùi d√πng'}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="order-summary">
      <div class="summary-row">
        <span>T·ªïng ti·ªÅn h√†ng:</span>
        <span>{{calculateItemsTotal() | currency:'VND':'symbol':'1.0-0'}}</span>
      </div>
      <div class="summary-row">
        <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
        <span>0 ‚Ç´</span>
      </div>
      <div class="summary-row total">
        <strong>T·ªïng thanh to√°n:</strong>
        <strong>{{order.totalPrice | currency:'VND':'symbol':'1.0-0'}}</strong>
      </div>
    </div>
  </div>

  <!-- Not Found -->
  <div *ngIf="!isLoading && !order" class="not-found">
    <h3>Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng</h3>
    <button (click)="onGoBack()" class="btn btn-primary">Quay l·∫°i</button>
  </div>
</div>

<!-- Modal ƒë√°nh gi√° s·∫£n ph·∫©m -->
<div *ngIf="showReviewModal" class="modal-overlay" (click)="closeReviewModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ƒê√°nh gi√° s·∫£n ph·∫©m</h3>
      <button class="modal-close" (click)="closeReviewModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="product-info">
        <h4>{{selectedProduct?.name}}</h4>
        <p>M√£ s·∫£n ph·∫©m: {{selectedProduct?.productId}}</p>
        <div class="reviewer-info">
          <small>ƒê√°nh gi√° d∆∞·ªõi t√™n: <strong>{{getReviewerName()}}</strong></small>
        </div>
        <p class="review-warning">‚ö†Ô∏è B·∫°n ch·ªâ c√≥ th·ªÉ ƒë√°nh gi√° s·∫£n ph·∫©m n√†y m·ªôt l·∫ßn</p>
      </div>
      
      <div class="rating-section">
        <label>ƒê√°nh gi√° c·ªßa b·∫°n: <span class="required">*</span></label>
        <div class="star-rating">
          <span *ngFor="let star of [1,2,3,4,5]" 
                (click)="setRating(star)"
                [class.active]="star <= currentRating"
                class="star">
            ‚òÖ
          </span>
        </div>
        <div class="rating-text">
          {{currentRating > 0 ? getRatingText(currentRating) : 'Vui l√≤ng ch·ªçn s·ªë sao'}}
        </div>
      </div>
      
      <div class="review-section">
        <label for="reviewComment">Nh·∫≠n x√©t chi ti·∫øt:</label>
        <textarea 
          id="reviewComment"
          [value]="reviewComment"
          (input)="onReviewCommentChange($event)"
          placeholder="H√£y chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m..."
          rows="4"
          class="review-textarea">
        </textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button (click)="closeReviewModal()" class="btn btn-cancel">H·ªßy</button>
      <button (click)="onSubmitReview()" 
              [disabled]="currentRating === 0 || isSubmittingReview || !isUserLoggedIn()"
              class="btn btn-submit">
        {{isSubmittingReview ? 'ƒêang g·ª≠i...' : 'G·ª≠i ƒë√°nh gi√°'}}
      </button>
    </div>
  </div>
</div>

<!-- Modal xem ƒë√°nh gi√° (gi·ªØ nguy√™n) -->
<div *ngIf="showViewReviewModal" class="modal-overlay" (click)="closeViewReviewModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ƒê√°nh gi√° c·ªßa b·∫°n</h3>
      <button class="modal-close" (click)="closeViewReviewModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="product-info">
        <h4>{{viewingReviewProduct?.name}}</h4>
        <p>M√£ s·∫£n ph·∫©m: {{viewingReviewProduct?.productId}}</p>
        <div class="reviewer-info">
          <small>ƒê√°nh gi√° b·ªüi: <strong>{{viewingReview?.reviewerName || '·∫®n danh'}}</strong></small>
        </div>
      </div>
      
      <div class="rating-section">
        <label>ƒê√°nh gi√°:</label>
        <div class="star-rating static">
          <span *ngFor="let star of [1,2,3,4,5]" 
                [class.active]="star <= viewingReview?.rating"
                class="star">
            ‚òÖ
          </span>
        </div>
        <div class="rating-text">
          {{getRatingText(viewingReview?.rating)}}
        </div>
      </div>
      
      <div class="review-section">
        <label>Nh·∫≠n x√©t:</label>
        <div class="review-content">
          {{viewingReview?.comment || 'Kh√¥ng c√≥ nh·∫≠n x√©t'}}
        </div>
      </div>
      
      <div class="review-date" *ngIf="viewingReview?.createdAt">
        ƒê√°nh gi√° ng√†y: {{formatDate(viewingReview.createdAt)}}
      </div>
    </div>
    <div class="modal-footer">
      <button (click)="closeViewReviewModal()" class="btn btn-primary">ƒê√≥ng</button>
    </div>
  </div>
</div>